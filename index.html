
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometric Hull Scanner</title>
    <style>
        :root {
            --bg: #050505;
            --ui: #121212;
            --accent: #00ff9d; /* Sci-fi Mint */
            --warn: #ff3333;
            --text: #e0e0e0;
        }

        body {
            font-family: 'Consolas', 'Courier New', monospace;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { 
            border: 1px solid var(--accent);
            padding: 10px 20px;
            text-transform: uppercase; 
            letter-spacing: 2px;
            font-size: 1.2rem;
            color: var(--accent);
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.2);
        }

        .controls {
            background: var(--ui);
            padding: 15px;
            border: 1px solid #333;
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .viewport {
            position: relative;
            border: 1px solid #333;
            background: #000;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            display: none;
        }

        canvas { display: block; max-width: 100%; }

        /* The HUD Overlay */
        .hud-overlay {
            position: absolute;
            top: 10px; left: 10px;
            color: var(--accent);
            font-size: 0.8rem;
            pointer-events: none;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 600px;
        }

        .stat-card {
            background: var(--ui);
            border-left: 3px solid var(--accent);
            padding: 10px;
        }
        
        .stat-label { font-size: 0.7rem; color: #666; text-transform: uppercase; }
        .stat-val { font-size: 1.1rem; font-weight: bold; color: #fff; }

        button {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
        }
        button:hover { opacity: 0.9; }

    </style>
</head>
<body>

    <h1>Convex Hull Scanner</h1>
    <div style="font-size: 0.7rem; color: #666;">ALGORITHM: GRAHAM_SCAN // SATURATION_FILTER // SINGLE_LOOP</div>

    <div class="controls">
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="engageHull()">Engage Wrap</button>
    </div>

    <div class="viewport" id="viewport">
        <canvas id="mainCanvas"></canvas>
        <div class="hud-overlay">
            STATUS: STANDBY<br>
            FILTER: CHROMATIC
        </div>
    </div>

    <div class="data-grid" id="dataGrid"></div>

    <script>
        const fileInput = document.getElementById('imageInput');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const viewport = document.getElementById('viewport');
        const dataGrid = document.getElementById('dataGrid');

        let originalImage = null;

        fileInput.addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        originalImage = img;
                        renderImage(img);
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        function renderImage(img) {
            viewport.style.display = 'block';
            let w = img.width;
            let h = img.height;
            const max = 700; // Limit for performance
            if (w > max || h > max) {
                const r = Math.min(max/w, max/h);
                w *= r; h *= r;
            }
            canvas.width = w;
            canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            dataGrid.innerHTML = '';
        }

        // --- CORE LOGIC ---
        function engageHull() {
            if (!originalImage) return;

            const w = canvas.width;
            const h = canvas.height;
            const data = ctx.getImageData(0, 0, w, h).data;
            
            // 1. Point Collection (With Wall Rejection)
            let points = [];
            const step = 5; // Skip pixels for speed

            for (let y = 0; y < h; y += step) {
                for (let x = 0; x < w; x += step) {
                    const i = (y * w + x) * 4;
                    const r = data[i], g = data[i+1], b = data[i+2];

                    if (isValidSkin(r, g, b)) {
                        points.push({x, y});
                    }
                }
            }

            if (points.length < 50) {
                alert("Target lost. No biological signature detected.");
                return;
            }

            // 2. Compute Convex Hull (Graham Scan)
            const hull = calculateConvexHull(points);

            // 3. Draw Results
            drawHull(hull, points.length);
            generateStats(hull, points.length);
        }

        // --- THE FIX: STRICTER SKIN FILTER ---
        function isValidSkin(r, g, b) {
            // A. Basic Red Dominance (Standard Skin)
            const basic = (r > 60) && (g > 40) && (b > 20) && (r > g) && (r > b);
            
            if (!basic) return false;

            // B. Wall Rejection (The Fix)
            // Calculate Saturation difference. 
            // Walls are often White/Gray (Low difference between R, G, B).
            // Skin has 'color'.
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const saturation = max - min;

            // If the difference between highest and lowest color channel is small, 
            // it's likely a gray/white wall or light.
            if (saturation < 15) return false; 

            // C. Brightness Cap (Reject Pure Lights)
            if (r > 240 && g > 240 && b > 240) return false;

            return true;
        }

        // --- MATH: GRAHAM SCAN ALGORITHM ---
        // Returns a sorted array of points forming the outer perimeter
        function calculateConvexHull(points) {
            // Sort by Y (lowest first)
            points.sort((a, b) => a.y - b.y || a.x - b.x);
            const start = points[0];

            // Sort by Polar Angle relative to start
            const sorted = points.slice(1).sort((a, b) => {
                const angA = Math.atan2(a.y - start.y, a.x - start.x);
                const angB = Math.atan2(b.y - start.y, b.x - start.x);
                return angA - angB;
            });

            // Build Stack
            const stack = [start, sorted[0]];
            for (let i = 1; i < sorted.length; i++) {
                let next = sorted[i];
                while (stack.length >= 2) {
                    const top = stack[stack.length - 1];
                    const second = stack[stack.length - 2];
                    const turn = (top.x - second.x) * (next.y - second.y) - (top.y - second.y) * (next.x - second.x);
                    
                    if (turn <= 0) stack.pop(); // Right turn or collinear -> reject
                    else break; // Left turn -> keep
                }
                stack.push(next);
            }
            return stack;
        }

        // --- VISUALIZATION ---
        function drawHull(hull, mass) {
            // Dim the background to make the scan pop
            ctx.fillStyle = "rgba(0,0,0,0.7)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw the Hull Line
            ctx.beginPath();
            ctx.moveTo(hull[0].x, hull[0].y);
            for (let i = 1; i < hull.length; i++) {
                ctx.lineTo(hull[i].x, hull[i].y);
            }
            ctx.closePath();
            
            // Tech Styling
            ctx.strokeStyle = "#00ff9d";
            ctx.lineWidth = 2;
            ctx.shadowColor = "#00ff9d";
            ctx.shadowBlur = 15;
            ctx.stroke();
            ctx.shadowBlur = 0; // Reset

            // Draw Vertices (Tech Dots)
            ctx.fillStyle = "#fff";
            hull.forEach((p, i) => {
                if (i % 3 === 0) { // Don't draw every single one, too crowded
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 2, 0, Math.PI*2);
                    ctx.fill();
                }
            });
        }

        function generateStats(hull, mass) {
            const seed = hull.length * mass;
            const tiers = ["LTN", "MTN", "HTN", "CHAD"];
            const tier = tiers[seed % 4];

            const html = `
                <div class="stat-card">
                    <div class="stat-label">Subject Classification</div>
                    <div class="stat-val" style="color:var(--accent)">${tier}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Biometric Mass</div>
                    <div class="stat-val">${(mass/1000).toFixed(1)}k px</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Envelope Vertices</div>
                    <div class="stat-val">${hull.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Structure Integrity</div>
                    <div class="stat-val">9${seed % 9}%</div>
                </div>
            `;
            dataGrid.innerHTML = html;
            
            // Update HUD
            document.querySelector('.hud-overlay').innerHTML = 
                `STATUS: LOCKED<br>TARGETS: 1 (CLUSTERED)<br>FILTER: ACTIVE`;
        }

    </script>
</body>
</html>
